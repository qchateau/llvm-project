name: Build latest clangd

on:
  push:
    branches:
      - 'release/clangd-*'

jobs:
  build_clangd:
    strategy:
      fail-fast: false
      matrix:
        docker-image: ["ubuntu-2004", "centos-7"]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        with:
          path: llvm-project
          fetch-depth: 1

      - name: Extract branch name
        run: |
          echo "::set-output name=tracked_branch::(echo ${GITHUB_REF#refs/heads/release/})"
          echo "::set-output name=this_branch::(echo ${GITHUB_REF#refs/heads/})"
        id: branches

      - name: Merge tracked branch
        uses: devmasx/merge-branch@v1.3.1
        with:
          type: now
          from_branch: ${{ steps.branches.outputs.tracked_branch }}
          target_branch: ${{ steps.branches.outputs.this_branch }}
          github_token: ${{ github.token }}

      # - name: Build docker image
      #   run: |
      #     cd $GITHUB_WORKSPACE/llvm-project/.github/images/
      #     docker build --file ${{ matrix.docker-image }}.dockerfile --tag clangd-image .

      # - name: Build clangd
      #   run: |
      #     mkdir out
      #     docker run \
      #       -v $GITHUB_WORKSPACE/llvm-project:/tmp/llvm-project/ \
      #       -v $GITHUB_WORKSPACE/out:/tmp/out/ \
      #       clangd-image /build.sh /tmp/llvm-project/ /tmp/out/

      # - name: Upload artifact
      #   uses: actions/upload-artifact@v2
      #   with:
      #     name: clangd-${{ matrix.docker-image }}
      #     path: out/clangd

      - name: Push changes
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ github.token }}
          branch: ${{ github.ref }}

  release_clangd:
    if: github.ref == 'refs/heads/clangd-release'
    runs-on: ubuntu-latest
    needs: build_clangd
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v2

      - name: Prepare artifacts
        run: |
          mkdir artifacts
          for name in $(ls); do
            if [ -e ./$name/clangd ]; then
              mv ./$name/clangd artifacts/$name
            fi
          done

      - name: Set date
        run: echo "NOW=$(date +'%Y-%m-%d')" >> $GITHUB_ENV

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: artifacts/*
          commit: ${{ github.ref }}
          tag: clangd-${{ env.NOW }}
          token: ${{ secrets.GITHUB_TOKEN }}
